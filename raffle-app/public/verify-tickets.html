<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ticket & Barcode Verification - Raffle App</title>
  <link rel="icon" type="image/png" href="logo.png">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
  
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
      color: #1e293b;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    /* Language Selector */
    .language-selector {
      display: flex;
      gap: 8px;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .lang-btn {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 6px;
      transition: all 0.3s;
      opacity: 0.6;
    }
    
    .lang-btn:hover {
      opacity: 1;
      background: rgba(102, 126, 234, 0.1);
    }
    
    .lang-btn.active {
      opacity: 1;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transform: scale(1.1);
    }
    
    /* Back Link */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: #667eea;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s;
      background: rgba(102, 126, 234, 0.1);
    }
    
    .back-link:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: translateX(-4px);
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
    }
    
    .stat-card.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .stat-card.primary h3,
    .stat-card.primary .value {
      color: white;
    }
    
    /* Search and Filter Section */
    .filter-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .filter-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto auto;
      gap: 16px;
      align-items: end;
      margin-bottom: 16px;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .filter-group label {
      font-size: 14px;
      font-weight: 600;
      color: #475569;
    }
    
    input[type="text"],
    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
      background: white;
    }
    
    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    
    .btn-secondary:hover {
      background: #667eea;
      color: white;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .export-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    /* Table Section */
    .table-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px 32px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      margin-bottom: 24px;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b3fa0 100%);
    }
    
    th .sort-icon {
      margin-left: 4px;
      opacity: 0.5;
    }
    
    th.sorted .sort-icon {
      opacity: 1;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }
    
    .barcode-cell {
      font-family: monospace;
      font-size: 14px;
      font-weight: 600;
    }
    
    .barcode-img {
      max-width: 120px;
      height: auto;
      margin-top: 4px;
      display: block;
    }
    
    .qr-thumbnail {
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: transform 0.3s;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
    }
    
    .qr-thumbnail:hover {
      transform: scale(1.1);
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-available {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-sold {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-printed {
      background: #dbeafe;
      color: #1e40af;
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    .pagination button {
      padding: 8px 16px;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination button.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .page-info {
      font-size: 14px;
      color: #64748b;
      padding: 0 16px;
    }
    
    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #64748b;
    }
    
    .loading::after {
      content: "...";
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    
    .empty-state h3 {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .close-modal {
      position: absolute;
      right: 16px;
      top: 16px;
      font-size: 28px;
      font-weight: bold;
      color: #64748b;
      cursor: pointer;
      line-height: 1;
      transition: color 0.2s;
    }
    
    .close-modal:hover {
      color: #ef4444;
    }
    
    .modal-content img {
      width: 100%;
      max-width: 400px;
      display: block;
      margin: 20px auto;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 2000;
      display: none;
      min-width: 220px;
      text-align: center;
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .filter-row {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }
      
      .header {
        padding: 16px;
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .filter-section {
        padding: 16px;
      }
      
      .filter-row {
        grid-template-columns: 1fr;
      }
      
      .table-section {
        padding: 16px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 8px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .export-buttons {
        flex-direction: column;
        width: 100%;
      }
      
      .export-buttons .btn {
        width: 100%;
        justify-content: center;
      }
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .header-actions,
      .filter-section,
      .pagination,
      .back-link,
      .export-buttons {
        display: none !important;
      }
      
      .table-section {
        box-shadow: none;
        border: 1px solid #e2e8f0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div>
        <h1>
          <span>üé´</span>
          <span data-translate="pageTitle">Ticket & Barcode Verification</span>
        </h1>
        <a href="/admin" class="back-link">
          ‚Üê <span data-translate="backToDashboard">Back to Admin Dashboard</span>
        </a>
      </div>
      <div class="header-actions">
        <!-- Language Selector -->
        <div class="language-selector">
          <button class="lang-btn" data-lang="en" title="English">üá∫üá∏</button>
          <button class="lang-btn" data-lang="ht" title="Krey√≤l Ayisyen">üá≠üáπ</button>
          <button class="lang-btn" data-lang="fr" title="Fran√ßais">üá´üá∑</button>
          <button class="lang-btn" data-lang="es" title="Espa√±ol">üá™üá∏</button>
        </div>
      </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card primary">
        <h3 data-translate="totalTickets">Total Tickets</h3>
        <div class="value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <h3 data-translate="availableTickets">Available Tickets</h3>
        <div class="value" id="stat-available">0</div>
      </div>
      <div class="stat-card">
        <h3 data-translate="soldTickets">Sold Tickets</h3>
        <div class="value" id="stat-sold">0</div>
      </div>
      <div class="stat-card">
        <h3 data-translate="categoryBreakdown">Category Breakdown</h3>
        <div id="stat-categories" style="font-size: 14px; color: #64748b; margin-top: 8px;">
          ABC: <span id="cat-abc">0</span> |
          EFG: <span id="cat-efg">0</span> |
          JKL: <span id="cat-jkl">0</span> |
          XYZ: <span id="cat-xyz">0</span>
        </div>
      </div>
    </div>
    
    <!-- Search and Filter Section -->
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-group">
          <label for="search" data-translate="searchLabel">Search Ticket or Barcode</label>
          <input 
            type="text" 
            id="search" 
            data-translate-placeholder="searchPlaceholder"
            placeholder="Enter ticket number or barcode..."
          >
        </div>
        <div class="filter-group">
          <label for="category" data-translate="categoryFilter">Category</label>
          <select id="category">
            <option value="" data-translate="allCategories">All Categories</option>
            <option value="ABC">ABC</option>
            <option value="EFG">EFG</option>
            <option value="JKL">JKL</option>
            <option value="XYZ">XYZ</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="status" data-translate="statusFilter">Status</label>
          <select id="status">
            <option value="" data-translate="allStatuses">All Statuses</option>
            <option value="AVAILABLE" data-translate="statusAvailable">Available</option>
            <option value="SOLD" data-translate="statusSold">Sold</option>
          </select>
        </div>
        <button class="btn btn-secondary" id="clearFilters">
          <span data-translate="clearFilters">Clear Filters</span>
        </button>
        <button class="btn btn-primary" id="searchBtn">
          <span data-translate="search">Search</span>
        </button>
      </div>
      
      <div class="export-buttons">
        <button class="btn btn-success" id="exportAll">
          üì• <span data-translate="exportAll">Export All</span>
        </button>
        <button class="btn btn-success" id="exportFiltered">
          üì• <span data-translate="exportFiltered">Export Filtered</span>
        </button>
        <button class="btn btn-secondary" id="printView">
          üñ®Ô∏è <span data-translate="printView">Print View</span>
        </button>
      </div>
    </div>
    
    <!-- Table Section -->
    <div class="table-section">
      <div id="loading" class="loading" style="display: none;">
        <span data-translate="loading">Loading tickets</span>
      </div>
      
      <div id="tableContainer">
        <table id="ticketsTable">
          <thead>
            <tr>
              <th data-sort="ticket_number">
                <span data-translate="ticketNumber">Ticket Number</span>
                <span class="sort-icon">‚Üï</span>
              </th>
              <th data-sort="barcode">
                <span data-translate="barcode">Barcode</span>
                <span class="sort-icon">‚Üï</span>
              </th>
              <th data-sort="category">
                <span data-translate="category">Category</span>
                <span class="sort-icon">‚Üï</span>
              </th>
              <th data-sort="price">
                <span data-translate="price">Price</span>
                <span class="sort-icon">‚Üï</span>
              </th>
              <th data-sort="status">
                <span data-translate="status">Status</span>
                <span class="sort-icon">‚Üï</span>
              </th>
              <th>
                <span data-translate="qrCode">QR Code</span>
              </th>
              <th>
                <span data-translate="buyer">Buyer</span>
              </th>
              <th>
                <span data-translate="seller">Seller</span>
              </th>
            </tr>
          </thead>
          <tbody id="ticketsBody">
          </tbody>
        </table>
        
        <div id="emptyState" class="empty-state" style="display: none;">
          <h3 data-translate="noTickets">No tickets found</h3>
          <p data-translate="tryAdjusting">Try adjusting your search or filter criteria</p>
        </div>
      </div>
      
      <!-- Pagination -->
      <div class="pagination" id="pagination">
        <button id="prevPage" data-translate="previous">Previous</button>
        <span class="page-info">
          <span data-translate="page">Page</span> 
          <span id="currentPage">1</span> 
          <span data-translate="of">of</span> 
          <span id="totalPages">1</span>
        </span>
        <button id="nextPage" data-translate="next">Next</button>
      </div>
    </div>
  </div>
  
  <!-- QR Code Modal -->
  <div id="qrModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2 data-translate="qrCodePreview">QR Code Preview</h2>
      <img id="qrModalImage" src="" alt="QR Code">
      <p id="qrModalTicket" style="text-align: center; font-weight: 600; margin-top: 16px;"></p>
    </div>
  </div>
  
  <!-- Notification -->
  <div class="notification" id="notification"></div>
  
  <script>
    // Translation system
    const translations = {
      en: {
        pageTitle: 'Ticket & Barcode Verification',
        backToDashboard: 'Back to Admin Dashboard',
        totalTickets: 'Total Tickets',
        availableTickets: 'Available Tickets',
        soldTickets: 'Sold Tickets',
        categoryBreakdown: 'Category Breakdown',
        searchLabel: 'Search Ticket or Barcode',
        searchPlaceholder: 'Enter ticket number or barcode...',
        categoryFilter: 'Category',
        allCategories: 'All Categories',
        statusFilter: 'Status',
        allStatuses: 'All Statuses',
        statusAvailable: 'Available',
        statusSold: 'Sold',
        clearFilters: 'Clear Filters',
        search: 'Search',
        exportAll: 'Export All',
        exportFiltered: 'Export Filtered',
        printView: 'Print View',
        loading: 'Loading tickets',
        ticketNumber: 'Ticket Number',
        barcode: 'Barcode',
        category: 'Category',
        price: 'Price',
        status: 'Status',
        qrCode: 'QR Code',
        buyer: 'Buyer',
        seller: 'Seller',
        noTickets: 'No tickets found',
        tryAdjusting: 'Try adjusting your search or filter criteria',
        previous: 'Previous',
        page: 'Page',
        of: 'of',
        next: 'Next',
        qrCodePreview: 'QR Code Preview',
        exportSuccess: 'Export started successfully',
        exportError: 'Failed to export tickets'
      },
      fr: {
        pageTitle: 'V√©rification des Billets et Codes-Barres',
        backToDashboard: 'Retour au Tableau de Bord Admin',
        totalTickets: 'Total des Billets',
        availableTickets: 'Billets Disponibles',
        soldTickets: 'Billets Vendus',
        categoryBreakdown: 'R√©partition par Cat√©gorie',
        searchLabel: 'Rechercher Billet ou Code-Barres',
        searchPlaceholder: 'Entrez le num√©ro de billet ou code-barres...',
        categoryFilter: 'Cat√©gorie',
        allCategories: 'Toutes les Cat√©gories',
        statusFilter: 'Statut',
        allStatuses: 'Tous les Statuts',
        statusAvailable: 'Disponible',
        statusSold: 'Vendu',
        clearFilters: 'Effacer les Filtres',
        search: 'Rechercher',
        exportAll: 'Exporter Tout',
        exportFiltered: 'Exporter Filtr√©s',
        printView: 'Vue Impression',
        loading: 'Chargement des billets',
        ticketNumber: 'Num√©ro de Billet',
        barcode: 'Code-Barres',
        category: 'Cat√©gorie',
        price: 'Prix',
        status: 'Statut',
        qrCode: 'Code QR',
        buyer: 'Acheteur',
        seller: 'Vendeur',
        noTickets: 'Aucun billet trouv√©',
        tryAdjusting: 'Essayez d\'ajuster vos crit√®res de recherche ou de filtre',
        previous: 'Pr√©c√©dent',
        page: 'Page',
        of: 'de',
        next: 'Suivant',
        qrCodePreview: 'Aper√ßu du Code QR',
        exportSuccess: 'Exportation d√©marr√©e avec succ√®s',
        exportError: '√âchec de l\'exportation des billets'
      },
      ht: {
        pageTitle: 'Verifikasyon Tik√® ak K√≤d-Ba',
        backToDashboard: 'Retounen nan Tablo B√≤ Administrat√®',
        totalTickets: 'Total Tik√®',
        availableTickets: 'Tik√® Disponib',
        soldTickets: 'Tik√® Vann',
        categoryBreakdown: 'Separasyon pa Kategori',
        searchLabel: 'Ch√®che Tik√® oswa K√≤d-Ba',
        searchPlaceholder: 'Antre nimewo tik√® oswa k√≤d-ba...',
        categoryFilter: 'Kategori',
        allCategories: 'Tout Kategori',
        statusFilter: 'Estati',
        allStatuses: 'Tout Estati',
        statusAvailable: 'Disponib',
        statusSold: 'Vann',
        clearFilters: 'Efase Filt√®',
        search: 'Ch√®che',
        exportAll: 'Eksp√≤te Tout',
        exportFiltered: 'Eksp√≤te sa ki Filtre',
        printView: 'Vi Enprime',
        loading: 'Chajman tik√® yo',
        ticketNumber: 'Nimewo Tik√®',
        barcode: 'K√≤d-Ba',
        category: 'Kategori',
        price: 'Pri',
        status: 'Estati',
        qrCode: 'K√≤d QR',
        buyer: 'Acht√®',
        seller: 'Vand√®',
        noTickets: 'Pa gen tik√®',
        tryAdjusting: 'Eseye ajiste krit√® rech√®ch oswa filt√® ou',
        previous: 'Anvan',
        page: 'Paj',
        of: 'sou',
        next: 'Pwochen',
        qrCodePreview: 'Ap√®si K√≤d QR',
        exportSuccess: 'Eksp√≤tasyon k√≤manse av√®k siks√®',
        exportError: 'Echwe eksp√≤tasyon tik√® yo'
      },
      es: {
        pageTitle: 'Verificaci√≥n de Boletos y C√≥digos de Barras',
        backToDashboard: 'Volver al Panel de Administraci√≥n',
        totalTickets: 'Total de Boletos',
        availableTickets: 'Boletos Disponibles',
        soldTickets: 'Boletos Vendidos',
        categoryBreakdown: 'Desglose por Categor√≠a',
        searchLabel: 'Buscar Boleto o C√≥digo de Barras',
        searchPlaceholder: 'Ingrese n√∫mero de boleto o c√≥digo de barras...',
        categoryFilter: 'Categor√≠a',
        allCategories: 'Todas las Categor√≠as',
        statusFilter: 'Estado',
        allStatuses: 'Todos los Estados',
        statusAvailable: 'Disponible',
        statusSold: 'Vendido',
        clearFilters: 'Limpiar Filtros',
        search: 'Buscar',
        exportAll: 'Exportar Todo',
        exportFiltered: 'Exportar Filtrados',
        printView: 'Vista de Impresi√≥n',
        loading: 'Cargando boletos',
        ticketNumber: 'N√∫mero de Boleto',
        barcode: 'C√≥digo de Barras',
        category: 'Categor√≠a',
        price: 'Precio',
        status: 'Estado',
        qrCode: 'C√≥digo QR',
        buyer: 'Comprador',
        seller: 'Vendedor',
        noTickets: 'No se encontraron boletos',
        tryAdjusting: 'Intente ajustar sus criterios de b√∫squeda o filtro',
        previous: 'Anterior',
        page: 'P√°gina',
        of: 'de',
        next: 'Siguiente',
        qrCodePreview: 'Vista Previa del C√≥digo QR',
        exportSuccess: 'Exportaci√≥n iniciada con √©xito',
        exportError: 'Error al exportar boletos'
      }
    };
    
    // Get current language
    function getCurrentLanguage() {
      return localStorage.getItem('raffleAppLanguage') || 'en';
    }
    
    // Set language
    function setLanguage(lang) {
      localStorage.setItem('raffleAppLanguage', lang);
      
      document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        if (translations[lang] && translations[lang][key]) {
          if (el.tagName === 'INPUT' || el.tagName === 'BUTTON') {
            el.textContent = translations[lang][key];
          } else {
            el.textContent = translations[lang][key];
          }
        }
      });
      
      document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
        const key = el.getAttribute('data-translate-placeholder');
        if (translations[lang] && translations[lang][key]) {
          el.placeholder = translations[lang][key];
        }
      });
      
      document.querySelectorAll('.lang-btn').forEach(btn => {
        if (btn.getAttribute('data-lang') === lang) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }
    
    // Initialize language
    document.addEventListener('DOMContentLoaded', function() {
      const currentLang = getCurrentLanguage();
      setLanguage(currentLang);
    });
    
    // Language button handlers
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const lang = btn.getAttribute('data-lang');
        setLanguage(lang);
      });
    });
    
    // State
    let currentPage = 1;
    let currentFilters = {
      search: '',
      category: '',
      status: ''
    };
    
    // Show notification
    function showNotification(message, duration = 3000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, duration);
    }
    
    // Fetch tickets
    async function fetchTickets(page = 1) {
      const loading = document.getElementById('loading');
      const tableContainer = document.getElementById('tableContainer');
      const emptyState = document.getElementById('emptyState');
      
      loading.style.display = 'block';
      tableContainer.style.display = 'none';
      
      try {
        const params = new URLSearchParams({
          page: page,
          limit: 50,
          ...currentFilters
        });
        
        const response = await fetch(`/api/admin/tickets/verify-list?${params}`);
        
        if (!response.ok) {
          throw new Error('Failed to fetch tickets');
        }
        
        const data = await response.json();
        
        // Update stats
        updateStats(data.stats);
        
        // Update table
        updateTable(data.tickets);
        
        // Update pagination
        updatePagination(data.page, data.pages, data.total);
        
        loading.style.display = 'none';
        
        if (data.tickets.length === 0) {
          emptyState.style.display = 'block';
          document.getElementById('ticketsTable').style.display = 'none';
        } else {
          emptyState.style.display = 'none';
          tableContainer.style.display = 'block';
          document.getElementById('ticketsTable').style.display = 'table';
        }
      } catch (error) {
        console.error('Error fetching tickets:', error);
        loading.style.display = 'none';
        showNotification('Error loading tickets');
      }
    }
    
    // Update stats
    function updateStats(stats) {
      document.getElementById('stat-total').textContent = stats.total.toLocaleString();
      document.getElementById('stat-available').textContent = stats.available.toLocaleString();
      document.getElementById('stat-sold').textContent = stats.sold.toLocaleString();
      document.getElementById('cat-abc').textContent = stats.by_category.ABC.toLocaleString();
      document.getElementById('cat-efg').textContent = stats.by_category.EFG.toLocaleString();
      document.getElementById('cat-jkl').textContent = stats.by_category.JKL.toLocaleString();
      document.getElementById('cat-xyz').textContent = stats.by_category.XYZ.toLocaleString();
    }
    
    // Update table
    function updateTable(tickets) {
      const tbody = document.getElementById('ticketsBody');
      tbody.innerHTML = '';
      
      tickets.forEach(ticket => {
        const tr = document.createElement('tr');
        
        // Status badge
        let statusClass = 'status-available';
        if (ticket.status === 'SOLD') statusClass = 'status-sold';
        
        // Generate barcode image
        let barcodeHtml = '';
        if (ticket.barcode) {
          barcodeHtml = `
            <div class="barcode-cell">
              ${ticket.barcode}
              <canvas class="barcode-img" data-barcode="${ticket.barcode}"></canvas>
            </div>
          `;
        } else {
          barcodeHtml = '<span style="color: #94a3b8;">N/A</span>';
        }
        
        // QR Code thumbnail
        let qrHtml = '<span style="color: #94a3b8;">N/A</span>';
        if (ticket.qr_code_data) {
          // Generate simple QR placeholder (in production, use actual QR generation)
          qrHtml = `<button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;" onclick="showQRModal('${ticket.ticket_number}', '${ticket.qr_code_data}')">View QR</button>`;
        }
        
        tr.innerHTML = `
          <td><strong>${ticket.ticket_number || 'N/A'}</strong></td>
          <td>${barcodeHtml}</td>
          <td>${ticket.category || 'N/A'}</td>
          <td>$${ticket.price ? parseFloat(ticket.price).toFixed(2) : '0.00'}</td>
          <td><span class="status-badge ${statusClass}">${ticket.status || 'N/A'}</span></td>
          <td>${qrHtml}</td>
          <td>${ticket.buyer_name || '-'}</td>
          <td>${ticket.seller_name || '-'}</td>
        `;
        
        tbody.appendChild(tr);
      });
      
      // Generate barcodes
      document.querySelectorAll('.barcode-img').forEach(canvas => {
        const barcodeValue = canvas.getAttribute('data-barcode');
        try {
          JsBarcode(canvas, barcodeValue, {
            format: 'CODE128',
            width: 1,
            height: 40,
            displayValue: false
          });
        } catch (e) {
          console.error('Error generating barcode:', e);
        }
      });
    }
    
    // Update pagination
    function updatePagination(page, totalPages, total) {
      currentPage = page;
      document.getElementById('currentPage').textContent = page;
      document.getElementById('totalPages').textContent = totalPages;
      
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= totalPages;
    }
    
    // Show QR modal
    function showQRModal(ticketNumber, qrData) {
      const modal = document.getElementById('qrModal');
      document.getElementById('qrModalTicket').textContent = `Ticket: ${ticketNumber}`;
      
      // For simplicity, show the QR data as text
      // In production, you'd generate actual QR image
      document.getElementById('qrModalImage').src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><text x="10" y="100" font-size="12">${encodeURIComponent(qrData.substring(0, 50))}</text></svg>`;
      
      modal.style.display = 'block';
    }
    window.showQRModal = showQRModal;
    
    // Close modal
    document.querySelector('.close-modal').addEventListener('click', () => {
      document.getElementById('qrModal').style.display = 'none';
    });
    
    window.addEventListener('click', (e) => {
      const modal = document.getElementById('qrModal');
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
    
    // Search with debounce
    let searchTimeout;
    document.getElementById('search').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentFilters.search = e.target.value;
        currentPage = 1;
        fetchTickets(currentPage);
      }, 300);
    });
    
    // Category filter
    document.getElementById('category').addEventListener('change', (e) => {
      currentFilters.category = e.target.value;
      currentPage = 1;
      fetchTickets(currentPage);
    });
    
    // Status filter
    document.getElementById('status').addEventListener('change', (e) => {
      currentFilters.status = e.target.value;
      currentPage = 1;
      fetchTickets(currentPage);
    });
    
    // Clear filters
    document.getElementById('clearFilters').addEventListener('click', () => {
      document.getElementById('search').value = '';
      document.getElementById('category').value = '';
      document.getElementById('status').value = '';
      currentFilters = { search: '', category: '', status: '' };
      currentPage = 1;
      fetchTickets(currentPage);
    });
    
    // Search button
    document.getElementById('searchBtn').addEventListener('click', () => {
      currentPage = 1;
      fetchTickets(currentPage);
    });
    
    // Pagination
    document.getElementById('prevPage').addEventListener('click', () => {
      if (currentPage > 1) {
        fetchTickets(currentPage - 1);
      }
    });
    
    document.getElementById('nextPage').addEventListener('click', () => {
      fetchTickets(currentPage + 1);
    });
    
    // Export functions
    document.getElementById('exportAll').addEventListener('click', async () => {
      try {
        window.location.href = '/api/admin/tickets/export-csv';
        const lang = getCurrentLanguage();
        showNotification(translations[lang].exportSuccess || 'Export started successfully');
      } catch (error) {
        console.error('Error exporting:', error);
        const lang = getCurrentLanguage();
        showNotification(translations[lang].exportError || 'Failed to export tickets');
      }
    });
    
    document.getElementById('exportFiltered').addEventListener('click', async () => {
      try {
        const params = new URLSearchParams(currentFilters);
        window.location.href = `/api/admin/tickets/export-csv?${params}`;
        const lang = getCurrentLanguage();
        showNotification(translations[lang].exportSuccess || 'Export started successfully');
      } catch (error) {
        console.error('Error exporting:', error);
        const lang = getCurrentLanguage();
        showNotification(translations[lang].exportError || 'Failed to export tickets');
      }
    });
    
    document.getElementById('printView').addEventListener('click', () => {
      window.print();
    });
    
    // Initial load
    fetchTickets(1);
  </script>
</body>
</html>
