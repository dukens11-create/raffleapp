PORT=5000
DB_PATH=./raffle.db
UPLOAD_DIR=uploads/
SESSION_SECRET=your_super_secret_session_key
STRIPE_SECRET_KEY=sk_test_yourkey
      db.run(
        "INSERT INTO users (role,name,phone,password) VALUES (?,?,?,?)",
        ["admin", "Admin", "0000000000", "admin123"]
      );
      console.log("‚úÖ Admin created ‚Üí phone: 0000000000 | password: admin123");
    }
  });
});

app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// ---------- REGISTRATION PAGE ----------
app.get("/register", (req, res) => {
  res.send(`
<!DOCTYPE html>
<html>
<head>
<title>Register - Raffle App</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{font-family:Arial;padding:20px;background:#1565c0;color:#fff}
input,button{padding:10px;margin:5px;width:100%;background:#1976d2;color:#fff;border:none;border-radius:4px}
.card{border:1px solid #1976d2;padding:15px;border-radius:8px;margin-bottom:20px;background:#1e88e5;color:#fff}
</style>
</head>
<body>
<h2>Register</h2>
<div class="card">
  <input id="name" placeholder="Name"/>
  <input id="phone" placeholder="Phone"/>
  <input id="password" type="password" placeholder="Password"/>
  <button onclick="register()">Register</button>
  <p id="msg"></p>
</div>
<script>
function register(){
  fetch('/register',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      name:name.value,
      phone:phone.value,
      password:password.value
    })
  }).then(r=>r.json()).then(d=>{
    msg.innerText = d.error || d.msg || '';
    if(d.success) setTimeout(()=>location.href='/', 1000);
  })
}
</script>
</body>
</html>
  `);
});

// ---------- REGISTRATION API ----------
app.post("/register", (req, res) => {
  const { name, phone, password } = req.body;
  if (!name || !phone || !password) return res.json({ error: "All fields required" });
  db.get("SELECT * FROM users WHERE phone=?", [phone], (err, user) => {
    if (user) return res.json({ error: "Phone already registered" });
    db.run(
      "INSERT INTO users (role,name,phone,password) VALUES (?,?,?,?)",
      ["seller", name, phone, password],
      (err) => {
        if (err) return res.json({ error: "Registration failed" });
        res.json({ success: true, msg: "Registered! Redirecting to login..." });
      }
    );
  });
});

// ---------- UI ----------
app.get("/", (req, res) => {
  res.send(`
<!DOCTYPE html>
<html>
<head>
<title>Raffle App</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{font-family:Arial;padding:20px;background:#1565c0;color:#fff}
input,button{padding:10px;margin:5px;width:100%;background:#1976d2;color:#fff;border:none;border-radius:4px}
.card{border:1px solid #1976d2;padding:15px;border-radius:8px;margin-bottom:20px;background:#1e88e5;color:#fff}
#reader{width:100% !important;max-width:350px;margin:auto;}
</style>
</head>
<body>
<h2>üéüÔ∏è Raffle Ticket System</h2>

<div class="card">
<h3>Login</h3>
<input id="phone" placeholder="Phone"/>
<input id="password" type="password" placeholder="Password"/>
<button onclick="login()">Login</button>
<p id="msg"></p>
<button onclick="toggleScanner()" id="scanBtn">Scan Barcode</button>
<div id="reader" style="display:none"></div>
<p>Don't have an account? <a href="/register">Register here</a></p>
</div>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script>
function login(){
  fetch('/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      phone:phone.value,
      password:password.value
    })
  }).then(r=>r.json()).then(d=>{
    if(d.role==='admin') location.href='/admin';
    if(d.role==='seller') location.href='/seller?name='+d.name;
    msg.innerText=d.error||''
  })
}

let scannerVisible = false;
let html5Qr;
function toggleScanner() {
  const reader = document.getElementById('reader');
  if (!scannerVisible) {
    reader.style.display = '';
    if (!html5Qr) {
      html5Qr = new Html5Qrcode('reader');
    }
    html5Qr.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        phone.value = decodedText;
        html5Qr.stop();
        reader.style.display = 'none';
        scannerVisible = false;
      },
      (err) => {}
    );
    scannerVisible = true;
    scanBtn.innerText = 'Close Scanner';
  } else {
    html5Qr && html5Qr.stop();
    reader.style.display = 'none';
    scannerVisible = false;
    scanBtn.innerText = 'Scan Barcode';
  }
}
</script>
</body>
</html>
  `);
});

// ---------- LOGIN ----------
app.post("/login", (req, res) => {
  const { phone, password } = req.body;
  db.get(
    "SELECT * FROM users WHERE phone=? AND password=?",
    [phone, password],
    (err, user) => {
      if (!user) return res.json({ error: "Invalid login" });
      res.json(user);
    }
  );
});

// ---------- ADMIN ----------
app.get("/admin", (req, res) => {
  res.send(`
<!DOCTYPE html>
<html>
<head>
<title>Admin Dashboard - Raffle App</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{font-family:Arial;padding:20px;background:#1565c0;color:#fff}
input,button{padding:10px;margin:5px;width:100%;background:#1976d2;color:#fff;border:none;border-radius:4px}
.card{border:1px solid #1976d2;padding:15px;border-radius:8px;margin-bottom:20px;background:#1e88e5;color:#fff}
</style>
</head>
<body>
<h2>üëë Admin Dashboard</h2>
<div class="card">
<h3>Create Seller</h3>
<input id="name" placeholder="Name"/>
<input id="phone" placeholder="Phone"/>
<input id="pass" placeholder="Password"/>
<button onclick="createSeller()">Create</button>
</div>
<div class="card">
<h3>Create Ticket</h3>
<input id="ticket" placeholder="Ticket Number"/>
<button onclick="createTicket()">Add Ticket</button>
</div>
<div class="card">
<h3>Bulk Import Tickets (Excel)</h3>
<form id="importForm" enctype="multipart/form-data" method="POST" action="/import-tickets">
  <input type="file" name="excel" accept=".xlsx,.xls" />
  <button type="submit">Import</button>
</form>
<p id="importMsg"></p>
</div>
<div class="card">
<h3>All Tickets</h3>
<div id="tickets"></div>
</div>
<div class="card">
<h3>Seller Sales Report</h3>
<div id="sales"></div>
</div>
<script>
function createSeller(){
 fetch('/create-seller',{method:'POST',headers:{'Content-Type':'application/json'},
 body:JSON.stringify({name:name.value,phone:phone.value,password:pass.value})})
 .then(()=>alert('Seller created'))
}

function createTicket(){
 fetch('/create-ticket',{method:'POST',headers:{'Content-Type':'application/json'},
 body:JSON.stringify({number:ticket.value})})
 .then(()=>load())
}

document.getElementById('importForm').onsubmit = function(e) {
  e.preventDefault();
  var formData = new FormData(importForm);
  fetch('/import-tickets', {
    method: 'POST',
    body: formData
  }).then(r=>r.json()).then(d=>{
    importMsg.innerText = d.msg || d.error || '';
    load();
  });
}

function load(){
 fetch('/tickets').then(r=>r.json()).then(d=>{
   tickets.innerHTML=d.map(t=>t.number+' - '+t.status).join('<br>')
 })
 fetch('/sales-report').then(r=>r.json()).then(d=>{
  sales.innerHTML = d.map(function(s){ return (s.sold_by + ': ' + s.count + ' tickets'); }).join('<br>');
 })
}
load()
</script>
</body>
</html>
  `);
});

// ---------- SELLER ----------
app.get("/seller", (req, res) => {
  const name = req.query.name;
  res.send(`
<!DOCTYPE html>
<html>
<head>
<title>Seller Dashboard - Raffle App</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
body{font-family:Arial;padding:20px;background:#1565c0;color:#fff}
input,button{padding:10px;margin:5px;width:100%;background:#1976d2;color:#fff;border:none;border-radius:4px}
.card{border:1px solid #1976d2;padding:15px;border-radius:8px;margin-bottom:20px;background:#1e88e5;color:#fff}
</style>
</head>
<body>
<h2>Seller: ${name}</h2>
<div class="card">
  <input id="ticket" placeholder="Ticket Number"/>
  <button onclick="sell()">Sell Ticket</button>
  <p id="msg"></p>
</div>
<script>
function sell(){
 fetch('/sell',{
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({number:ticket.value,seller:'${name}'})
 }).then(r=>r.json()).then(d=>{
   msg.innerText=d.msg||d.error
 })
}
</script>
</body>
</html>
  `);
});

// ---------- API ----------
app.post("/create-seller", (req, res) => {
  const { name, phone, password } = req.body;
  db.run(
    "INSERT INTO users (role,name,phone,password) VALUES (?,?,?,?)",
    ["seller", name, phone, password]
  );
  res.sendStatus(200);
});

app.post("/create-ticket", (req, res) => {
  db.run(
    "INSERT OR IGNORE INTO tickets (number,status) VALUES (?,?)",
    [req.body.number, "available"]
  );
  res.sendStatus(200);
});

app.get("/tickets", (req, res) => {
  db.all("SELECT * FROM tickets", (err, rows) => res.json(rows));
});

app.post("/sell", (req, res) => {
  const { number, seller } = req.body;
  db.get("SELECT * FROM tickets WHERE number=?", [number], (err, t) => {
    if (!t) return res.json({ error: "Ticket not found" });
    if (t.status === "sold") return res.json({ error: "Already sold" });
    db.run(
      "UPDATE tickets SET status='sold', sold_by=?, sold_at=datetime('now') WHERE number=?",
      [seller, number]
    );
    res.json({ msg: "Ticket sold" });
  });
});

// ---------- BULK IMPORT TICKETS ----------
app.post('/import-tickets', upload.single('excel'), (req, res) => {
  if (!req.file) return res.json({ error: 'No file uploaded' });
  try {
    const workbook = xlsx.readFile(req.file.path);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const data = xlsx.utils.sheet_to_json(sheet);
    let count = 0;
    data.forEach(row => {
      if (row.number) {
        db.run(
          "INSERT OR IGNORE INTO tickets (number,status) VALUES (?,?)",
          [row.number, "available"]
        );
        count++;
      }
    });
    res.json({ msg: `Imported ${count} tickets.` });
  } catch (e) {
    res.json({ error: 'Import failed' });
  }
});

// ---------- SALES REPORT API ----------
app.get('/sales-report', (req, res) => {
  db.all("SELECT sold_by, COUNT(*) as count FROM tickets WHERE status='sold' AND sold_by IS NOT NULL GROUP BY sold_by", (err, rows) => {
    res.json(rows || []);
  });
});

// ---------- START ----------
app.listen(PORT, () => {
  console.log(`üöÄ Running on http://localhost:${PORT}`);
});